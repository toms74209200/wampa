# Wampa Technical Requirements

## 依存関係
- 外部依存を持たず、Go標準ライブラリのみを使用して実装する
  - ファイル監視: `fsnotify`パッケージまたはOSのsystem callを使用
  - ファイル操作: `os`、`io/fs`パッケージ
  - HTTP/HTTPS: `net/http`パッケージ
  - 設定ファイル解析: 
    - 最終目標: `encoding/toml`パッケージ（Go 2.0で導入予定）
    - 暫定対応: `encoding/json`パッケージを使用し、後にTOMLに移行
  - コマンドライン引数: `flag`パッケージ

## アーキテクチャ設計
- 責務ごとに明確に分離されたモジュール構造
  - ファイル監視モジュール
  - ファイル読み込みモジュール (ローカル/リモート)
  - ファイル結合モジュール
  - 設定管理モジュール
- 参照透過性を持った純粋関数として実装
  - 副作用は明示的な境界で管理
  - テスト可能なインターフェース設計

## 実装要件
- ファイル監視はポーリングではなくOSのイベント通知を使用
- ファイル変更検知時は差分ではなく全体を再構築
- エラーは適切なコンテキストとともにログ出力
- 並行処理はチャネルを使用して明示的に制御
- 全ての公開関数・型にはドキュメントコメントを付与
- コードは明示的にエラー処理を行い、エラーを無視しない

## プロジェクト管理要件

### プロジェクト状況の追跡
- プロジェクトルートにTODO.mdファイルを設置し、プロジェクトの状態を常に把握可能にする
- AIコーディングエージェントが迅速にコンテキストを把握できる形式で記録する
- 必要な記録項目：
  - 現在の作業コンテキスト（作業中のファイル、実装中の機能、関連するテスト、現在の課題）
  - エラーとバグの追跡情報（コンパイルエラー、テストエラー、リントエラー）
  - 実装ステータス（完了した機能、進行中の機能、保留中の機能）
  - メモと参考情報
- TODO.md自体をWampaのユースケース例として活用し、開発プロセスの改善にフィードバック

例）TODO.mdのフォーマット:
```markdown
# Wampa 開発状況
## 現在の作業コンテキスト
- **作業中のファイル**: `pkg/watcher/file_watcher.go`
- **実装中の機能**: ファイル変更検知イベントハンドラー
- **関連するテスト**: `pkg/watcher/file_watcher_test.go`
- **現在の課題**: fsnotifyのイベントが重複して発生する問題を解決中

## エラーとバグ追跡
- **コンパイルエラー**: `pkg/formatter/formatter.go:45` - インターフェース実装が不完全
  ```
  formatter.go:45:6: not enough methods for Formatter interface, missing Format method
  ```
- **テストエラー**: `TestFileWatcher_Watch`
  ```
  === RUN   TestFileWatcher_Watch
     watcher_test.go:32: expected event count 1, got 2
  --- FAIL: TestFileWatcher_Watch (0.15s)
  ```
- **リントエラー**: `pkg/config/config.go:23` - エラー処理が不十分
  ```
  config.go:23: error return value not checked (errcheck)
  ```

## 実装ステータス
### 完了した機能
- [x] 基本的な設計とディレクトリ構造 (2023-06-15)
- [x] 設定ファイル読み込み機能 (2023-06-16)
  - [x] TOML解析
  - [x] デフォルト値の設定

### 進行中の機能
- [ ] ファイル監視機能
  - [x] ローカルファイルの監視
  - [ ] リモートファイルの定期チェック

## メモと参考情報
- fsnotifyのイベント重複問題: https://github.com/fsnotify/fsnotify/issues/62
```

### CI/CD要件
- 以下の項目を自動実行する環境を整備：
  - テストの自動実行（small、medium、large）
  - リンターチェック
  - 受入テストの自動実行
- テストカバレッジの自動計測と報告
- GitHub Actionsによる自動化

## テスト要件

### 必要なテストの種類
- 単体テスト
  - 各モジュールの機能を独立して検証
  - 必ずSmall テストとして実装すること

- 受入テスト
  - `.feature`ファイルに基づいて実装
  - リソース要件に応じてmedium/largeテストとして実装

## 仕様管理要件
- 仕様はBDD（Behavior Driven Development）形式で管理
  - `/spec/spec.md`で基本仕様を定義
  - 基本仕様から`.feature`ファイルを生成
  - すべての仕様が`.feature`ファイルとして実装され、受入テストと紐付いていること

- 仕様とテストの追跡可能性を確保
  - 各`.feature`ファイルは`spec.md`の要件と紐付けられていること
  - 仕様変更時は対応する`.feature`ファイルも更新すること

## プロジェクト構造
### コアコンポーネント
- `/pkg/watcher/watcher.go`
  - ファイル監視の基本インターフェースと型定義
  - イベント処理のコア機能を提供
  - 純粋なGoインターフェースとして実装

- `/pkg/formatter/formatter.go`
  - ファイル結合処理のインターフェースと実装
  - 出力フォーマットの定義と変換処理
  - Markdownフレンドリーな出力を生成

- `/pkg/config/config.go`
  - 設定の基本構造と検証ロジック
  - アプリケーション設定の型定義
  - バリデーションルールの実装

### 実装ファイル
- `/pkg/watcher/local_watcher.go`
  - ローカルファイル監視の具体的な実装
  - OSのファイルシステムイベントを処理
  - ポーリングとイベント通知の制御

- `/pkg/config_impl/file.go`
  - OS依存の設定ファイル処理
  - ファイルシステムとの直接的なやり取り
  - エラー処理とローカライゼーション

### テスト実装
- `/pkg/*/`*`_test.go`
  - 各コンポーネントの単体テスト
  - テーブル駆動テストの実装
  - モックオブジェクトの定義

- `/tests/acceptance/steps.go`
  - 受入テストのステップ定義
  - Gherkinシナリオの実装
  - テスト環境のセットアップとクリーンアップ

### 設定ファイル
- `/scripts/coverage_pkgs.txt`
  - カバレッジ計測対象パッケージの定義
  - テストカバレッジの統計管理

- `/.golangci.yml`
  - リンターの設定
  - コードスタイルの統一ルール

### CI/CD設定
- `/.github/workflows/`
  - GitHub Actionsワークフロー定義
  - 自動テストとビルドの設定
  - プルリクエストの検証ルール

## 完了の定義
- 全ての単体テスト (Small Tests) が成功すること
- 全ての受入テスト（Gherkinシナリオ）が成功すること
- テストカバレッジが80%以上であること
- lintエラーがないこと